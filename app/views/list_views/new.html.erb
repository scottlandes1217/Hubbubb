<% content_for :navbar do %>
  <%= render 'shared/navbar_org' %>
<% end %>

<div class="container my-5">
  <div class="card shadow-sm border-0" style="max-width: 900px; margin: 0 auto;">
    <div class="card-header bg-primary text-white">
      <h2 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New List View</h2>
    </div>
    <div class="card-body p-4">
  
  <%= form_with model: [@organization, @list_view], local: true do |f| %>
    <%= f.hidden_field :object_type %>
    <%= f.hidden_field :object_id %>
    
    <div class="mb-3">
      <%= f.label :name, "View Name", class: "form-label" %>
      <%= f.text_field :name, class: "form-control", required: true %>
    </div>
    
    <div class="mb-3">
      <div class="form-check">
        <%= f.check_box :is_default, class: "form-check-input" %>
        <%= f.label :is_default, "Set as default view", class: "form-check-label" %>
      </div>
    </div>
    
    <div class="mb-3">
      <div class="form-check">
        <%= f.check_box :is_public, class: "form-check-input" %>
        <%= f.label :is_public, "Make this view public (shared with organization)", class: "form-check-label" %>
      </div>
    </div>
    
    <div class="mb-3">
      <%= f.label :sort_by, "Sort By", class: "form-label" %>
      <%= f.select :sort_by, 
          options_for_select(@available_columns.map { |col| [col[:display_name], col[:api_name]] }, @list_view.sort_by),
          { include_blank: "None" },
          { class: "form-select" } %>
    </div>
    
    <div class="mb-3">
      <%= f.label :sort_direction, "Sort Direction", class: "form-label" %>
      <%= f.select :sort_direction, 
          options_for_select([["Ascending", "asc"], ["Descending", "desc"]], @list_view.sort_direction),
          {},
          { class: "form-select" } %>
    </div>
    
    <div class="mb-3">
      <label class="form-label">Columns to Display</label>
      <div class="row">
        <% @available_columns.each do |column| %>
          <div class="col-md-4 mb-2">
            <div class="form-check">
              <%= check_box_tag "list_view[columns][]", 
                  column[:api_name], 
                  @list_view.columns.include?(column[:api_name]),
                  class: "form-check-input",
                  id: "column_#{column[:api_name]}" %>
              <%= label_tag "column_#{column[:api_name]}", column[:display_name], class: "form-check-label" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    
    <div class="mb-3">
      <label class="form-label">Filters</label>
      <div id="filters-container">
        <% if @list_view.filters.any? %>
          <% @list_view.filters.each_with_index do |filter, index| %>
            <%= render 'filter_row', filter: filter, index: index, available_columns: @available_columns %>
          <% end %>
        <% end %>
      </div>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addFilter()">
        <i class="fas fa-plus"></i> Add Filter
      </button>
    </div>
    
      <div class="d-flex justify-content-between mt-4 pt-3 border-top">
        <%= f.submit "Create View", class: "btn btn-primary btn-lg px-4" %>
        <%= link_to "Cancel", organization_list_views_path(@organization, object_type: @list_view.object_type, object_id: @list_view.object_id), class: "btn btn-outline-secondary btn-lg px-4" %>
      </div>
    </div>
  </div>
  <% end %>
</div>

<script>
  let filterIndex = <%= @list_view.filters.length %>;
  
  function addFilter() {
    const container = document.getElementById('filters-container');
    const filterRow = document.createElement('div');
    filterRow.className = 'filter-row mb-2';
    filterRow.innerHTML = `
      <div class="row g-2">
        <div class="col-md-4">
          <select name="list_view[filters][${filterIndex}][field]" class="form-select form-select-sm" required>
            <option value="">Select Field</option>
            <% @available_columns.each do |column| %>
              <option value="<%= column[:api_name] %>"><%= column[:display_name] %></option>
            <% end %>
          </select>
        </div>
        <div class="col-md-3">
          <select name="list_view[filters][${filterIndex}][operator]" class="form-select form-select-sm" required>
            <option value="equals">Equals</option>
            <option value="not_equals">Not Equals</option>
            <option value="contains">Contains</option>
            <option value="not_contains">Not Contains</option>
            <option value="starts_with">Starts With</option>
            <option value="greater_than">Greater Than</option>
            <option value="less_than">Less Than</option>
            <option value="is_null">Is Null</option>
            <option value="is_not_null">Is Not Null</option>
          </select>
        </div>
        <div class="col-md-4">
          <input type="text" name="list_view[filters][${filterIndex}][value]" class="form-control form-control-sm" placeholder="Value">
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.filter-row').remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    `;
    container.appendChild(filterRow);
    filterIndex++;
  }
</script>

