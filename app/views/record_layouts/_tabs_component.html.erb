<!-- Tabs Component Partial -->
<script>
  console.log('[PF] Tabs component partial loaded');
  
  function buildWorkingTabs(comp) {
    // ROOT CAUSE FIX: Check drag flag FIRST, before ANY calls to comp.components()
    // comp.components() triggers ensureInList which causes infinite recursion during drags
    if (window.__pf_isMovingComponent === true) {
      return; // Don't do anything during drags - exit immediately
    }
    
    const isUpdating = comp.getAttributes()?.['_updating-tabs'] === 'true';
    const compEl = comp.getEl();
    
    // Prevent loops
    if (!isUpdating && compEl?.__pf_building_tabs) {
      return;
    }
    if (compEl && !isUpdating) compEl.__pf_building_tabs = true;
    
    // CRITICAL: Read tabs-json from HTML element FIRST (before checking structure)
    // This ensures we get the saved data even if attributes aren't set yet
    let tabsJson = null;
    if (compEl) {
      tabsJson = compEl.getAttribute('tabs-json');
      if (tabsJson) {
        // Decode HTML entities before parsing
        const textarea = document.createElement('textarea');
        textarea.innerHTML = tabsJson;
        tabsJson = textarea.value;
        comp.addAttributes({ 'tabs-json': tabsJson });
      }
    }
    
    // If not in HTML, try attributes
    if (!tabsJson) {
      tabsJson = comp.getAttributes()['tabs-json'];
    }
    
    // Get tabs data - NEVER use defaults if we have saved data
    let tabs = [];
    if (tabsJson) {
      try {
        tabs = JSON.parse(tabsJson);
        if (!Array.isArray(tabs) || tabs.length === 0) {
          console.warn('[PF] tabs-json exists but is invalid or empty:', tabsJson);
        }
      } catch(e) {
        console.error('[PF] Error parsing tabs-json:', e, 'tabsJson:', tabsJson);
        // If parsing fails, try to fix HTML entities and parse again
        try {
          const textarea = document.createElement('textarea');
          textarea.innerHTML = tabsJson;
          const decoded = textarea.value;
          tabs = JSON.parse(decoded);
        } catch(e2) {
          console.error('[PF] Failed to parse tabs-json even after decoding:', e2);
          // Use default tabs if parsing completely fails
          tabs = [{ id: 'tab1', title: 'Tab 1' }];
        }
      }
    }
    
    // Only use default if we truly have no saved data (new component) or parsing failed
    if (!tabsJson || tabs.length === 0) {
      tabs = [{ id: 'tab1', title: 'Tab 1' }];
      comp.addAttributes({ 'tabs-json': JSON.stringify(tabs), 'active-tab-id': tabs[0]?.id || 'tab1' });
    }
    
    // Skip if structure already exists (check both DOM and component tree)
    if (!isUpdating) {
      const hasDomStructure = compEl?.querySelector('.pf-tabs')?.querySelector('.pf-tabs-header')?.querySelector('.pf-tabs-body');
      const hasComponentStructure = comp.components().find(c => {
        const el = c.getEl();
        return el?.classList?.contains('pf-tabs');
      });
      
      if (hasDomStructure || hasComponentStructure) {
        if (compEl) compEl.__pf_building_tabs = false;
        // Ensure buttons exist even if structure already exists
        const compElForButtons = comp.getEl();
        if (compElForButtons) {
          if (window.getComputedStyle(compElForButtons).position === 'static') {
            compElForButtons.style.position = 'relative';
          }
          // Create buttons if they don't exist
          if (!compElForButtons.querySelector(':scope > .rb-edit-tabs')) {
            const editBtn = document.createElement('span');
            editBtn.className = 'rb-edit-tabs';
            editBtn.setAttribute('data-role', 'rb-edit-tabs');
            editBtn.title = 'Edit Tabs';
            editBtn.textContent = '✎';
            editBtn.style.cssText = 'position: absolute; top: 4px; right: 30px; background: rgba(0,0,0,0.6); color: #fff; border-radius: 12px; width: 22px; height: 22px; align-items: center; justify-content: center; cursor: pointer; z-index: 9999; pointer-events: auto;';
            editBtn.onclick = (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (window.openTabsConfigModal) window.openTabsConfigModal(comp);
            };
            compElForButtons.insertBefore(editBtn, compElForButtons.firstChild);
          }
          if (!compElForButtons.querySelector(':scope > .rb-del')) {
            const delBtn = document.createElement('span');
            delBtn.className = 'rb-del';
            delBtn.setAttribute('data-role', 'rb-del');
            delBtn.title = 'Delete';
            delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 448 512" fill="currentColor"><path d="M135.2 17.7C140.6 7.2 151.7 0 164 0h120c12.3 0 23.4 7.2 28.8 17.7L328 32H432c8.8 0 16 7.2 16 16s-7.2 16-16 16H16C7.2 64 0 56.8 0 48S7.2 32 16 32H120l15.2-14.3zM32 96H416l-21.2 371.6c-1.8 31.3-27.7 56.4-59.1 56.4H112.3c-31.4 0-57.3-25.1-59.1-56.4L32 96zm112 80c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16s16-7.2 16-16V192c0-8.8-7.2-16-16-16zm80 0c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16s16-7.2 16-16V192c0-8.8-7.2-16-16-16zm80 0c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16s16-7.2 16-16V192c0-8.8-7.2-16-16-16z"/></svg>';
            delBtn.style.cssText = 'position: absolute; top: 4px; right: 6px; background: rgba(0,0,0,0.7); color: #fff; border-radius: 12px; width: 22px; height: 22px; align-items: center; justify-content: center; cursor: pointer; z-index: 99999; pointer-events: auto;';
            delBtn.onclick = (e) => {
              e.preventDefault();
              e.stopPropagation();
              const editor = window.recordLayoutBuilderInstance?.editor || window.grapesjs;
              const view = editor?.Components?.getView(comp);
              if (view?.onDelete) view.onDelete(e);
              else comp.remove();
            };
            compElForButtons.insertBefore(delBtn, compElForButtons.firstChild);
          }
        }
        restoreActiveTabState(comp);
        // Re-attach click handlers even if structure exists (important after reload)
        attachTabClickHandlers(comp);
        return;
      }
    }
    
    // Clear existing components before rebuilding
    // ROOT CAUSE FIX: Use DOM check instead of comp.components() - it triggers ensureInList recursion
    const hasDomTabs = compEl?.querySelector('.pf-tabs');
    // ROOT CAUSE FIX: Check drag flag before calling comp.components('') - it triggers ensureInList recursion
    if ((hasDomTabs && isUpdating) || (!hasDomTabs && !isUpdating)) {
      if (!window.__pf_isMovingComponent) {
        comp.components('');
      }
    }
    
    // Create structure
    const tabsWrapper = comp.append('<div class="pf-tabs pf-interactive"></div>')[0];
    const header = tabsWrapper.append('<div class="pf-tabs-header"></div>')[0];
    const body = tabsWrapper.append('<div class="pf-tabs-body"></div>')[0];
    
    // Lock wrapper components - but ensure they don't block parent dragging
    [tabsWrapper, header, body].forEach(c => {
      c.set({ selectable: false, hoverable: false, draggable: false, droppable: false, editable: false, copyable: false, highlightable: false });
      // Ensure pointer events bubble up so parent can be dragged
      const cEl = c.getEl();
      if (cEl) {
        cEl.style.pointerEvents = 'auto'; // Allow events to bubble
      }
    });
    
    // Create tabs
    tabs.forEach((t, i) => {
      const btn = header.append(`<span class="pf-tab-btn ${i === 0 ? 'active' : ''}" data-tab-id="${t.id}">${t.title}</span>`)[0];
      btn.set({ selectable: false, hoverable: true, draggable: false, droppable: false, editable: false, copyable: false, highlightable: false });
      
      const section = body.append(`<div class="pf-tab-section ${i === 0 ? 'active' : ''}" data-role="pf-tab-section" data-tab-id="${t.id}"></div>`)[0];
      section.set({ droppable: true, accept: ['record-field', 'record-partial', 'record-section', 'record-tabs'], selectable: false, hoverable: false, highlightable: false, draggable: false });
    });
    
    // Attach click handlers after all tabs are created
    setTimeout(() => {
      attachTabClickHandlers(comp);
    }, 100);
    
    // Create buttons as DOM elements directly on the component element
    const compElForButtons = comp.getEl();
    if (compElForButtons) {
      // Ensure container has relative positioning
      if (window.getComputedStyle(compElForButtons).position === 'static') {
        compElForButtons.style.position = 'relative';
      }
      
      // Edit button - create or reuse existing
      let editBtn = compElForButtons.querySelector(':scope > .rb-edit-tabs');
      if (!editBtn) {
        editBtn = document.createElement('span');
        editBtn.className = 'rb-edit-tabs';
        editBtn.setAttribute('data-role', 'rb-edit-tabs');
        editBtn.title = 'Edit Tabs';
        editBtn.textContent = '✎';
        editBtn.style.cssText = 'position: absolute; top: 4px; right: 30px; background: rgba(0,0,0,0.6); color: #fff; border-radius: 12px; width: 22px; height: 22px; align-items: center; justify-content: center; cursor: pointer; z-index: 9999; pointer-events: auto;';
        editBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (window.openTabsConfigModal) window.openTabsConfigModal(comp);
        };
        compElForButtons.insertBefore(editBtn, compElForButtons.firstChild);
      }
      
      // Delete button - create or reuse existing
      let delBtn = compElForButtons.querySelector(':scope > .rb-del');
      if (!delBtn) {
        delBtn = document.createElement('span');
        delBtn.className = 'rb-del';
        delBtn.setAttribute('data-role', 'rb-del');
        delBtn.title = 'Delete';
        delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 448 512" fill="currentColor"><path d="M135.2 17.7C140.6 7.2 151.7 0 164 0h120c12.3 0 23.4 7.2 28.8 17.7L328 32H432c8.8 0 16 7.2 16 16s-7.2 16-16 16H16C7.2 64 0 56.8 0 48S7.2 32 16 32H120l15.2-14.3zM32 96H416l-21.2 371.6c-1.8 31.3-27.7 56.4-59.1 56.4H112.3c-31.4 0-57.3-25.1-59.1-56.4L32 96zm112 80c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16s16-7.2 16-16V192c0-8.8-7.2-16-16-16zm80 0c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16s16-7.2 16-16V192c0-8.8-7.2-16-16-16zm80 0c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16s16-7.2 16-16V192c0-8.8-7.2-16-16-16z"/></svg>';
        delBtn.style.cssText = 'position: absolute; top: 4px; right: 6px; background: rgba(0,0,0,0.7); color: #fff; border-radius: 12px; width: 22px; height: 22px; align-items: center; justify-content: center; cursor: pointer; z-index: 99999; pointer-events: auto;';
        delBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const editor = window.recordLayoutBuilderInstance?.editor || window.grapesjs;
          const view = editor?.Components?.getView(comp);
          if (view?.onDelete) view.onDelete(e);
          else comp.remove();
        };
        compElForButtons.insertBefore(delBtn, compElForButtons.firstChild);
      }
    }
    
    // Configure main component - ensure it's draggable
    comp.set({ draggable: true, droppable: false, selectable: true, hoverable: true, highlightable: true });
    
    // Clear flag and restore state
    setTimeout(() => {
      if (compEl) compEl.__pf_building_tabs = false;
      restoreActiveTabState(comp);
      // Ensure handlers are attached
      attachTabClickHandlers(comp);
    }, 200);
  }


  function attachTabClickHandlers(comp) {
    try {
      const wrapper = comp.getEl()?.querySelector('.pf-tabs');
      if (!wrapper) return;
      const header = wrapper.querySelector('.pf-tabs-header');
      if (!header) return;
      
      header.querySelectorAll('.pf-tab-btn').forEach(btn => {
        const tabId = btn.getAttribute('data-tab-id');
        if (!tabId) return;
        
        // Remove old handler if exists
        if (btn.__pf_click) {
          btn.removeEventListener('click', btn.__pf_click);
        }
        
        // Create new handler
        const handler = (e) => {
          e.preventDefault();
          e.stopPropagation();
          comp.addAttributes({ 'active-tab-id': tabId });
          // Remove active from all buttons
          header.querySelectorAll('.pf-tab-btn').forEach(b => b.classList.remove('active'));
          // Remove active from all sections
          wrapper.querySelectorAll('[data-role="pf-tab-section"]').forEach(s => {
            if (s.classList.contains('pf-tab-section')) {
              s.classList.remove('active');
            }
          });
          // Add active to clicked button
          btn.classList.add('active');
          // Add active to corresponding section
          const section = wrapper.querySelector(`[data-role="pf-tab-section"][data-tab-id="${tabId}"]`);
          if (section && section.classList.contains('pf-tab-section')) {
            section.classList.add('active');
          }
        };
        
        btn.__pf_click = handler;
        btn.addEventListener('click', handler);
      });
    } catch(e) {
      console.warn('[PF] Error attaching click handlers:', e);
    }
  }

  function restoreActiveTabState(comp) {
    try {
      const wrapper = comp.getEl()?.querySelector('.pf-tabs');
      if (!wrapper) return;
      const header = wrapper.querySelector('.pf-tabs-header');
      if (!header) return;
      
      let activeTabId = comp.getAttributes()['active-tab-id'];
      if (!activeTabId) {
        const firstBtn = header.querySelector('.pf-tab-btn');
        if (firstBtn) {
          activeTabId = firstBtn.getAttribute('data-tab-id');
          comp.addAttributes({ 'active-tab-id': activeTabId });
        }
      }
      
      if (activeTabId) {
        // Remove active from all buttons
        header.querySelectorAll('.pf-tab-btn').forEach(b => b.classList.remove('active'));
        // Remove active from all sections (be specific)
        wrapper.querySelectorAll('[data-role="pf-tab-section"]').forEach(s => {
          if (s.classList.contains('pf-tab-section')) {
            s.classList.remove('active');
          }
        });
        // Add active to correct button
        const activeBtn = header.querySelector(`.pf-tab-btn[data-tab-id="${activeTabId}"]`);
        if (activeBtn) activeBtn.classList.add('active');
        // Add active to correct section
        const activeSection = wrapper.querySelector(`[data-role="pf-tab-section"][data-tab-id="${activeTabId}"]`);
        if (activeSection && activeSection.classList.contains('pf-tab-section')) {
        activeSection.classList.add('active');
        }
      }
          } catch(e) {
      console.warn('[PF] Error restoring active tab:', e);
    }
  }

  function pfGenerateId(prefix = 't') { 
    return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2,6)}`; 
  }
  
  function pfParseTabsJson(attr) { 
    try { return JSON.parse(attr || '[]'); } catch(_) { return []; } 
  }
  
  function pfStringifyTabsJson(arr) { 
    try { return JSON.stringify(arr || []); } catch(_) { return '[]'; } 
  }

  function defineTabsComponent(editor) {
    editor.DomComponents.addType('record-tabs', {
      model: {
        defaults: {
          'tabs-json': '[]',
          'active-tab-id': '',
          tagName: 'div',
          attributes: { class: 'pf-tabs-container pf-interactive', 'data-comp-kind': 'record-tabs' },
          editable: false,
          draggable: true,
          copyable: false,
          droppable: false,
          selectable: true,
          hoverable: true,
          highlightable: true,
          components: ''
        },
        toHTML(opts = {}) {
          const el = this.getEl();
          if (!el) return this.constructor.prototype.toHTML.call(this, opts);
          
          const tabsWrapper = el.querySelector('.pf-tabs');
          if (!tabsWrapper) return this.constructor.prototype.toHTML.call(this, opts);
          
            const attrs = this.getAttributes();
            let html = '<div';
          ['tabs-json', 'active-tab-id', 'data-comp-kind', 'data-comp-id'].forEach(key => {
                const val = attrs[key];
                if (val != null && val !== '') {
                  html += ` ${key}="${String(val).replace(/"/g, '&quot;').replace(/&/g, '&amp;')}"`;
              }
            });
            const classes = this.get('classes').map(c => c.get('name')).join(' ');
          if (classes) html += ` class="${classes}"`;
            html += '>';
            
          const tabsWrapperComp = this.components().find(c => c.getEl()?.classList?.contains('pf-tabs'));
            if (tabsWrapperComp) {
                html += tabsWrapperComp.toHTML(opts);
            } else {
              html += tabsWrapper.outerHTML;
            }
            html += '</div>';
            return html;
        }
      },
      view: {
        events: { 
          'click [data-role="rb-del"]': 'onDelete',
          'click [data-role="rb-edit-tabs"]': 'onEdit'
        },
        onRender() {
          // Call buildWorkingTabs which will create structure and buttons
          buildWorkingTabs(this.model);
        },
        onDelete(e) { 
          e.preventDefault(); 
          e.stopPropagation(); 
          this.model.remove();
        },
        onEdit(e) {
          e.preventDefault();
          e.stopPropagation();
          if (window.openTabsConfigModal) window.openTabsConfigModal(this.model);
        }
      }
    });
    
    // Inject runtime CSS
    const style = document.createElement('style');
    style.textContent = `
.pf-tabs-container { position: relative; }
.pf-tabs { border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
.pf-tabs-header { background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; }
.pf-tab-btn { padding: 8px 16px; cursor: pointer; border-right: 1px solid #ddd; background: #f8f9fa; transition: background-color 0.2s; }
.pf-tab-btn:hover { background: #e9ecef; }
.pf-tab-btn.active { background: #fff; border-bottom: 2px solid #007bff; margin-bottom: -1px; }
.pf-tabs-body { background: #fff; padding: 16px; }
.pf-tab-section { display: none; }
.pf-tab-section.active { display: block; }
`;
    document.head.appendChild(style);
  }

  function getRuntimeCode() {
    return `/* RUNTIME: Tabs JavaScript and CSS */
// Runtime tabs functionality - ONLY runs on rendered pages, not in builder
(function() {
  function initTabs() {
    const isBuilder = (window.parent !== window && window.parent.grapesjs) || document.getElementById('gjs') || window.location.pathname.includes('/record_layouts/builder');
    if (isBuilder) return;
    document.querySelectorAll('.pf-tabs-container').forEach(container => {
      if (container.__pf_tabs_initialized) return;
      container.__pf_tabs_initialized = true;
      const wrapper = container.querySelector('.pf-tabs');
      const header = wrapper?.querySelector('.pf-tabs-header');
      if (!header) return;
      header.querySelectorAll('.pf-tab-btn').forEach(btn => {
        if (btn.__pf_runtime_click) return;
        btn.__pf_runtime_click = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const tabId = btn.getAttribute('data-tab-id');
          // Remove active from all buttons
          header.querySelectorAll('.pf-tab-btn').forEach(b => b.classList.remove('active'));
          // Remove active from all sections (be specific)
          wrapper.querySelectorAll('[data-role="pf-tab-section"]').forEach(s => {
            if (s.classList.contains('pf-tab-section')) {
              s.classList.remove('active');
            }
          });
          // Add active to clicked button
          btn.classList.add('active');
          // Add active to corresponding section (be specific)
          const section = wrapper.querySelector(\`[data-role="pf-tab-section"][data-tab-id="\${tabId}"]\`);
          if (section && section.classList.contains('pf-tab-section')) {
            section.classList.add('active');
          }
        };
        btn.addEventListener('click', btn.__pf_runtime_click);
      });
      // Set first tab as active if none is active
      if (!header.querySelector('.pf-tab-btn.active') && header.querySelector('.pf-tab-btn')) {
        const first = header.querySelector('.pf-tab-btn');
        const firstTabId = first.getAttribute('data-tab-id');
        first.classList.add('active');
        const firstSection = wrapper.querySelector(\`[data-role="pf-tab-section"][data-tab-id="\${firstTabId}"]\`);
        if (firstSection && firstSection.classList.contains('pf-tab-section')) {
          firstSection.classList.add('active');
        }
      }
    });
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initTabs);
  else initTabs();
  if (typeof Turbo !== 'undefined') {
    document.addEventListener('turbo:load', initTabs);
    document.addEventListener('turbo:frame-load', initTabs);
  }
})();

// Runtime tabs CSS
.pf-tabs-container { position: relative; }
.pf-tabs { border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
.pf-tabs-header { background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; }
.pf-tab-btn { padding: 8px 16px; cursor: pointer; border-right: 1px solid #ddd; background: #f8f9fa; transition: background-color 0.2s; }
.pf-tab-btn:hover { background: #e9ecef; }
.pf-tab-btn.active { background: #fff; border-bottom: 2px solid #007bff; margin-bottom: -1px; }
.pf-tabs-body { background: #fff; padding: 16px; }
.pf-tab-section { display: none; }
.pf-tab-section.active { display: block; }`;
  }

  window.TabsComponent = {
    buildWorkingTabs,
    pfGenerateId,
    pfParseTabsJson,
    pfStringifyTabsJson,
    defineTabsComponent,
    restoreActiveTabState,
    attachTabClickHandlers,
    getRuntimeCode
  };
</script>
