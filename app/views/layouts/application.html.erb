<!DOCTYPE html>
<html>
  <head>
    <title>hubbubb</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Resource hints for faster CDN loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- Preload Bootstrap JS for faster dropdown initialization -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" as="script">

    <!-- Preload logo for faster rendering (high priority) -->
    <%= preload_link_tag asset_path("hubbub-logo-large.png"), as: :image, fetchpriority: "high" %>

    <!-- Critical CSS loaded first -->
    <!-- Bootstrap CSS (via CDN for simplicity) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin>

    <!-- FontAwesome (loaded early for icons) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" crossorigin>
    
    <!-- Prevent icon flash with inline critical CSS -->
    <style>
      /* Prevent FOUT (Flash of Unstyled Text) for FontAwesome icons */
      .fas, .far, .fal, .fab, .fa {
        font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands", "Font Awesome 6 Pro" !important;
        font-weight: 900;
        display: inline-block;
        font-style: normal;
        font-variant: normal;
        text-rendering: auto;
        line-height: 1;
      }
      /* Reserve space for icons to prevent layout shift */
      i.fas, i.far, i.fal, i.fab, i.fa {
        min-width: 1em;
        text-align: center;
      }
    </style>

    <!-- Application CSS -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

    <!-- Trix CSS (less critical, can load after) -->
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.0/dist/trix.css" crossorigin>

    <!-- Import Maps for JavaScript (defer loading) -->
    <%= javascript_importmap_tags %>

    <!-- Bootstrap JavaScript (via CDN) - async for faster loading -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" async></script>
    <script>
      // Aggressively initialize dropdowns - check multiple times until Bootstrap is ready
      function initializeDropdowns() {
        if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
          // Bootstrap is ready, initialize all dropdowns
          document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(function(element) {
            if (!bootstrap.Dropdown.getInstance(element)) {
              try {
                new bootstrap.Dropdown(element);
              } catch(e) {
                // Already initialized or error, ignore
              }
            }
          });
          return true; // Bootstrap is ready
        }
        return false; // Bootstrap not ready yet
      }
      
      // Try to initialize immediately
      if (!initializeDropdowns()) {
        // Bootstrap not ready, poll until it is (max 20 attempts = ~2 seconds)
        let attempts = 0;
        const maxAttempts = 20;
        const pollInterval = setInterval(function() {
          attempts++;
          if (initializeDropdowns() || attempts >= maxAttempts) {
            clearInterval(pollInterval);
          }
        }, 100);
      }
      
      // Also try on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          if (!initializeDropdowns()) {
            // If still not ready, poll a few more times
            let attempts = 0;
            const maxAttempts = 10;
            const pollInterval = setInterval(function() {
              attempts++;
              if (initializeDropdowns() || attempts >= maxAttempts) {
                clearInterval(pollInterval);
              }
            }, 50);
          }
        });
      }
      
      // Re-initialize on Turbo navigations (critical for SPA behavior)
      document.addEventListener('turbo:load', function() {
        // Try immediately
        if (!initializeDropdowns()) {
          // Poll until ready (faster polling on navigation)
          let attempts = 0;
          const maxAttempts = 15;
          const pollInterval = setInterval(function() {
            attempts++;
            if (initializeDropdowns() || attempts >= maxAttempts) {
              clearInterval(pollInterval);
            }
          }, 50);
        }
      });
    </script>

    <%= yield :head if content_for?(:head) %>
  </head>

  <body>
    <%= render 'shared/global_alert' %>
    <%= yield :navbar %>
    <div class="main-content">
      <%= yield %> <!-- Main content goes here -->
    </div>
    
    <%= yield :javascript if content_for?(:javascript) %>
  </body>
</html>
